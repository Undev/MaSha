(function(){var l=function(){this.set_hash=function(z){window.location.hash=z};this.get_hash=function(){return window.location.hash};this.add_hashchange=function(z){p(window,"hashchange",z)}};var e=function(z){this.options=w({},e.default_options,z);w(this,{counter:0,savedSel:[],ranges:{},childs:[],blocks:{}});this.init()};e.version="29.09.2011-12:18:53";e.default_options={regexp:"[^\\s,;:\u2013.!?<>\u2026\\n\u00a0\\*]+",selectable:"selectable-content",marker:"txtselect_marker",ignored:null,select_message:null,location:new l(),validate:false,enable_haschange:true,onMark:null,onUnmark:null,onHashRead:function(){var z=o(this.selectable,"user_selection_true");if(z&&!this.hash_was_read){this.hash_was_read=true;window.setTimeout(function(){var A=0,B=0;while(z){A+=z.offsetLeft;B+=z.offsetTop;z=z.offsetParent}window.scrollTo(A,B-150)},1)}},is_block:function(z){return z.nodeName=="BR"||v(y(z,"display"),["inline","none"])==-1}};e.prototype={init:function(){this.selectable=(typeof this.options.selectable=="string"?document.getElementById(this.options.selectable):this.options.selectable);if(typeof this.options.marker=="string"){this.marker=document.getElementById(this.options.marker);if(this.marker===null){this.marker=document.createElement("a");this.marker.setAttribute("id",this.options.marker);this.marker.setAttribute("href","#");document.body.appendChild(this.marker)}}else{this.marker=this.options.marker}if(typeof this.options.regexp!="string"){throw"regexp is set as string"}this.regexp=new RegExp(this.options.regexp,"ig");var D=this;if(!this.selectable){return}this.is_ignored=this.construct_ignored(this.options.ignored);if(this.options.select_message){this.init_message()}this.enumerateElements();var A;p(this.selectable,"mouseup",function(E){A=s(E);window.setTimeout(z,1)});function z(){var E=new RegExp(D.options.regexp,"g");var F=window.getSelection().toString();if(F==""||!E.test(F)){return}if(!D.range_is_selectable()){return}D.marker.style.top=A.y-33+"px";D.marker.style.left=A.x+5+"px";g(D.marker,"show")}function C(E){var F=E.touches.item(0);A={x:F.pageX,y:F.pageY}}p(this.selectable,"touchmove",C);p(this.selectable,"touchstart",C);p(this.selectable,"touchend",function(){window.setTimeout(function(){var F=window.getSelection();if(F.rangeCount){var E=F.getRangeAt(0).getClientRects();var G=E[E.length-1];if(G){A={x:G.left+G.width+document.body.scrollLeft,y:G.top+G.height/2+document.body.scrollTop}}}z()},1)});function B(E){f(E);u(E);k(D.marker,"show");if(!D.range_is_selectable()){return}D.addSelection();D.updateHash();if(D.options.onMark){D.options.onMark.call(D)}if(D.options.select_message){D._show_message()}}p(this.marker,"click",B);p(this.marker,"touchend",B);p(document,"click",function(F){var E=F.target||F.srcElement;if(E!=D.marker){k(D.marker,"show")}});if(this.options.enable_haschange){this.options.location.add_hashchange(function(){if(D.last_hash!=D.options.location.get_hash()){var F=[];for(var E in D.ranges){F.push(E)}D.delete_selections(F);D.readHash()}})}this.readHash()},delete_selections:function(D){var z=[];for(var C=D.length;C--;){var A=D[C];var B=c(this.selectable,A);var E=o(B[B.length-1],"closewrap");E.parentNode.removeChild(E);this.removeTextSelection(B);z.push(this.ranges[A]);delete this.ranges[A]}},removeTextSelection:function(B){for(var A=B.length;A--;){var C=B[A];for(var z=0;z<C.childNodes.length;z++){C.parentNode.insertBefore(C.childNodes[z],C)}C.parentNode.removeChild(C)}},is_internal:function(z){while(z.parentNode){if(z==this.selectable){return true}z=z.parentNode}return false},_siblingNode:function(A,B,z,D,C){C=C||this.regexp;while(A.parentNode&&this.is_internal(A)){while(A[B+"Sibling"]){A=A[B+"Sibling"];while(A.nodeType==1&&A.childNodes.length){A=A[z+"Child"]}if(A.nodeType==3&&(A.data.match(C)!=null)){return{_container:A,_offset:D*A.data.length}}}A=A.parentNode}return null},prevNode:function(z,A){return this._siblingNode(z,"previous","last",1,A)},nextNode:function(z,A){return this._siblingNode(z,"next","first",0,A)},wordCount:function m(B){var A=0;if(B.nodeType==3){var z=B.nodeValue.match(this.regexp);if(z){A+=z.length}}else{if(B.childNodes&&B.childNodes.length){var C=d(B);for(i=C.length;i--;){A+=C[i].nodeValue.match(this.regexp).length}}}return A},words:function(z,D,F){if(z.nodeType==1){z=h(z)}var E=z.data.substring(0,D).match(this.regexp);if(E!=null){if(F=="start"){E=E.length+1}if(F=="end"){E=E.length}}else{E=1}var B=z;var A=this.getNum(z);var C=this.getFirstTextNode(A);while(B&&B!=C){B=this.prevNode(B,/.*/)._container;E+=this.wordCount(B)}return A+":"+E},symbols:function(B){var z=0;if(B.nodeType==3){z=B.nodeValue.length}else{if(B.childNodes&&B.childNodes.length){var C=d(B);for(var A=C.length;A--;){z+=C[A].nodeValue.length}}}return z},updateHash:function(){var B=[];for(key in this.ranges){B.push(this.ranges[key])}var A=$('input[name="revision-id"]').val();if(typeof A!==undefined){history.pushState(null,null,"?oldid="+A)}var z="#sel="+B.join(";");this.last_hash=z;this.options.location.set_hash(z)},readHash:function(){var A=this.splittedHash();if(!A){return}for(var z=0;z<A.length;z++){this.deserializeSelection(A[z])}this.updateHash();if(this.options.onHashRead){this.options.onHashRead.call(this)}},splittedHash:function(){var z=this.options.location.get_hash();if(!z){return null}z=z.replace(/^#/,"").replace(/;+$/,"");var A="";if(!/^sel\=(?:\d+\:\d+(?:\:[^:;]*)?\,\d+\:\d+(?:\:[^:;]*)?;)*\d+\:\d+(?:\:[^:;]*)?\,\d+\:\d+(?:\:[^:;]*)?$/.test(z)){return null}z=z.substring(4,z.length);return z.split(";")},deserializeSelection:function(B){var A=window.getSelection();if(A.rangeCount>0){A.removeAllRanges()}var z=this.deserializeRange(B);if(z){this.addSelection(z)}},deserializeRange:function(E){var A=/^([^,]+),([^,]+)$/.exec(E);var z=A[1].split(":");var G=A[2].split(":");if(parseInt(z[0],10)<parseInt(G[0],10)||(z[0]==G[0]&&parseInt(z[1],10)<=parseInt(G[1],10))){var D=function(){var K={};var J=window.location.search.substring(1);var L=J.split("&");for(var I=0;I<L.length;I++){var M=L[I].split("=");if(typeof K[M[0]]==="undefined"){K[M[0]]=M[1]}else{if(typeof K[M[0]]==="string"){var H=[K[M[0]],M[1]];K[M[0]]=H}else{K[M[0]].push(M[1])}}}return K}();if(D.hasOwnProperty("oldid")){z[0]=parseInt(z[0],10)+2;G[0]=parseInt(G[0],10)+2}var F=this.deserializePosition(z,"start"),B=this.deserializePosition(G,"end");if(F.node&&B.node){var C=document.createRange();C.setStart(F.node,F.offset);C.setEnd(B.node,B.offset);if(!this.options.validate||this.validateRange(C,z[2],G[2])){return C}}}if(window.console&&(typeof window.console.warn=="function")){window.console.warn("Cannot deserialize range: "+E)}return null},validateRange:function(z,B,A){var D=true,C;if(B){C=this.getPositionChecksum(z.getWordIterator(this.regexp));D=D&&B==C}if(A){C=this.getPositionChecksum(z.getWordIterator(this.regexp,true));D=D&&A==C}return D},getRangeChecksum:function(z){sum1=this.getPositionChecksum(z.getWordIterator(this.regexp));sum2=this.getPositionChecksum(z.getWordIterator(this.regexp,true));return[sum1,sum2]},getPositionChecksum:function(z){return""},deserializePosition:function(D,G){var C=this.blocks[parseInt(D[0],10)];var z;var E,F=0,A=false;while(C){var B=new RegExp(this.options.regexp,"ig");while((myArray=B.exec(C.data))!=null){F++;if(F==D[1]){if(G=="start"){E=myArray.index}if(G=="end"){E=B.lastIndex}return{node:C,offset:parseInt(E,10)}}}C=this.nextNode(C,/.*/);C=C?C._container:null;if(C&&this.isFirstTextNode(C)){C=null}}return{node:null,offset:0}},serializeRange:function(A){var C=this.words(A.startContainer,A.startOffset,"start");var z=this.words(A.endContainer,A.endOffset,"end");if(this.options.validate){var B=this.getRangeChecksum(A);C+=":"+B[0];z+=":"+B[1]}return C+","+z},checkSelection:function(z){this.checkPosition(z,z.startOffset,z.startContainer,"start");this.checkPosition(z,z.endOffset,z.endContainer,"end");this.checkBrackets(z);this.checkSentence(z);return z},checkPosition:function(E,C,z,F){var D=this,G;function I(J){return J.match(D.regexp)!=null}function H(J){return J.match(D.regexp)==null}function A(J,L,M){var K=L;while(L>0&&M(J.data.charAt(L-1))){L--}return L}function B(J,L,M){var K=L;while(L<J.data.length&&M(J.data.charAt(L))){L++}return L}if(z.nodeType==1&&C>0){if(C<z.childNodes.length){z=z.childNodes[C];C=0}else{container_txtnodes=d(z);z=container_txtnodes[container_txtnodes.length-1];C=z.data.length}}if(F=="start"){if(z.nodeType==1&&r(x(z))!=""){z=h(z);C=0}if(z.nodeType!=3||z.data.substring(C).match(this.regexp)==null){G=this.nextNode(z);z=G._container;C=G._offset}C=B(z,C,H);C=A(z,C,I);E.setStart(z,C)}if(F=="end"){if(z.nodeType==1&&r(x(z))!=""&&C!=0){z=z.childNodes[E.endOffset-1];container_txtnodes=d(z);z=container_txtnodes[container_txtnodes.length-1];C=z.data.length}if(z.nodeType!=3||z.data.substring(0,C).match(this.regexp)==null){G=this.prevNode(z);z=G._container;C=G._offset}C=A(z,C,H);C=B(z,C,I);E.setEnd(z,C)}},checkBrackets:function(z){this._checkBrackets(z,"(",")",/\(|\)/g,/\(x*\)/g);this._checkBrackets(z,"\u00ab","\u00bb",/\\u00ab|\\u00bb/g,/\u00abx*\u00bb/g)},_checkBrackets:function(D,z,B,C,E){var G=D.toString();var H=G.match(C);var F;if(H){H=H.join("");var A=H.length+1;while(H.length<A){A=H.length;H=H.replace(E,"x")}if(H.charAt(H.length-1)==B&&G.charAt(G.length-1)==B){if(D.endOffset==1){F=this.prevNode(D.endContainer);D.setEnd(F.container,F.offset)}else{D.setEnd(D.endContainer,D.endOffset-1)}}if(H.charAt(0)==z&&G.charAt(0)==z){if(D.startOffset==D.startContainer.data.length){F=this.nextNode(D.endContainer);D.setStart(F.container,F.offset)}else{D.setStart(D.startContainer,D.startOffset+1)}}}},checkSentence:function(E){var C,z;if(E.endOffset==E.endContainer.data.length){C=this.nextNode(E.endContainer,/.*/);if(!C){return null}z=C._container.data.charAt(0)}else{C={_container:E.endContainer,_offset:E.endOffset};z=E.endContainer.data.charAt(E.endOffset)}if(z.match(/\.|\?|\!/)){var H=E.toString();if(H.match(/(\.|\?|\!)\s+[A-Z\u0410-\u042f\u0401]/)){return F()}if(E.startOffset==0&&E.startContainer.previousSibling&&E.startContainer.previousSibling.nodeType==1&&E.startContainer.previousSibling.className=="selection_index"){return F()}var A,D=E.getElementIterator();while((A=D())){if(A.nodeType==1&&A.className=="selection_index"){return F()}}if(H.charAt(0).match(/[A-Z\u0410-\u042f\u0401]/)){var B=E.startContainer.data.substring(0,E.startOffset);if(!B.match(/\S/)){var G=this.prevNode(E.startContainer,/\W*/);B=G._container.data}B=r(B);if(B.charAt(B.length-1).match(/(\.|\?|\!)/)){return F()}}return null}function F(){E.setEnd(C._container,C._offset+1)}},mergeSelections:function(F){var C=[];var E=F.getElementIterator();var D=E();var K=D;var I=q(D,"user_selection_true");if(I){I=/(num\d+)(?:$| )/.exec(I.className)[1];F.setStart(h(o(this.selectable,I)),0);C.push(I)}while(D){if(D.nodeType==1&&a(D,"user_selection_true")){var L=/(num\d+)(?:$|)/.exec(D.className)[0];if(v(L,C)==-1){C.push(L)}}K=D;D=E()}K=q(K,"user_selection_true");if(K){K=/(num\d+)(?:$| )/.exec(K.className)[1];var H=d(n(this.selectable,K));var B=H[H.length-1];F.setEnd(B,B.length)}if(C.length){var J=F.startContainer,A=F.startOffset,G=F.endContainer,z=F.endOffset;this.delete_selections(C);F.setStart(J,A);F.setEnd(G,z)}return F},addSelection:function(z){z=z||this.getFirstRange();z=this.checkSelection(z);z=this.mergeSelections(z);var A="num"+this.counter;this.ranges[A]=this.serializeRange(z);z.wrapSelection(A+" user_selection_true");this.addSelectionEvents(A)},addSelectionEvents:function(D){var B=false;var F=this;var C=c(this.selectable,D);for(var A=C.length;A--;){p(C[A],"mouseover",function(){for(var G=C.length;G--;){g(C[G],"hover")}window.clearTimeout(B)});p(C[A],"mouseout",function(H){var G=H.relatedTarget;while(G&&G.parentNode&&G.className!=this.className){G=G.parentNode}if(!G||G.className!=this.className){B=window.setTimeout(function(){for(var I=C.length;I--;){k(C[I],"hover")}},2000)}})}var E=document.createElement("a");E.className="txtsel_close";E.href="#";var z=document.createElement("span");z.className="closewrap";z.appendChild(E);p(E,"click",function(G){f(G);F.delete_selections([D]);F.updateHash();if(F.options.onUnmark){F.options.onUnmark.call(F)}});C[C.length-1].appendChild(z);this.counter++;window.getSelection().removeAllRanges()},getFirstRange:function(){var A=window.getSelection();var z=A.rangeCount?A.getRangeAt(0):null;return z},enumerateElements:function(){var z=this.selectable;var C=0;var B=this;A(z);function A(G){var F=G.childNodes;var J=false;var I=false;var K;for(var M=0;M<F.length;++M){var E=F.item(M);var H=E.nodeType;if(H==3&&!E.nodeValue.match(B.regexp)){continue}else{if(H==3){if(!I){C++;var N=document.createElement("span");N.id="selection_index"+C;N.className="selection_index";E.parentNode.insertBefore(N,E);M++;B.blocks[C]=E;J=I=true}}else{if(H==1){if(!B.is_ignored(E)){var D=B.options.is_block(E);if(D){var L=A(E);J=J||L;I=false}else{if(!I){I=A(E);J=J||I}}}}}}}return J}},isFirstTextNode:function(A){var z=[A.previousSibling,A.parentNode.previousSibling];for(var B=z.length;B--;){if(z[B]&&z[B].nodeType==1&&z[B].className=="selection_index"){return true}}return false},getFirstTextNode:function(z){if(!z){return null}var A=document.getElementById("selection_index"+z);if(A){if(A.nextSibling.nodeType==1){return A.nextSibling.childNodes[0]}else{return A.nextSibling}}return null},getNum:function(z){while(z.parentNode){while(z.previousSibling){z=z.previousSibling;while(z.nodeType==1&&z.childNodes.length){z=z.lastChild}if(z.nodeType==1&&z.className=="selection_index"){return z.id.replace("selection_index","")}}z=z.parentNode}return null},construct_ignored:function(z){if(typeof z=="function"){return z}else{if(typeof z=="string"){var F=[],E=[],C=[];var B=z.split(",");for(var A=0;A<B.length;A++){var D=r(B[A]);if(D.charAt(0)=="#"){F.push(D.substr(1))}else{if(D.charAt(0)=="."){E.push(D.substr(1))}else{C.push(D)}}}return function(H){var G;for(G=F.length;G--;){if(H.id==F[G]){return true}}for(G=E.length;G--;){if(a(H,E[G])){return true}}for(G=C.length;G--;){if(H.tagName==C[G].toUpperCase()){return true}}return false}}else{return function(){return false}}}},range_is_selectable:function(){var B,G,A,C=true;var F=this.getFirstRange();if(!F){return false}var E=F.getElementIterator();while((B=E())){if(B.nodeType==3&&B.data.match(this.regexp)!=null){G=G||B;A=B}B=(C&&B.nodeType==3)?B.parentNode:B;C=false;if(B.nodeType==1){var D=B;while(D!=this.selectable&&D.parentNode){if(this.is_ignored(D)){return false}D=D.parentNode}if(D!=this.selectable){return false}}}var H=q(G,"user_selection_true");var I=q(A,"user_selection_true");if(H&&I){var z=/(?:^| )(num\d+)(?:$| )/;return(z.exec(H.className)[1]!=z.exec(I.className)[1])}return true},init_message:function(){var z=this;this.msg=(typeof this.options.select_message=="string"?document.getElementById(this.options.select_message):this.options.select_message);this.close_button=this.get_close_button();this.msg_autoclose=null;p(this.close_button,"click",function(A){f(A);z.hide_message();z.save_message_closed();clearTimeout(z.msg_autoclose)})},get_close_button:function(){return this.msg.getElementsByTagName("a")[0]},get_message_closed:function(){if(window.localStorage){return !!localStorage.masha_warning}else{return !!document.cookie.match(/(?:^|;)\s*masha-warning=/)}},save_message_closed:function(){if(window.localStorage){localStorage.masha_warning="true"}else{if(!this.get_closed()){document.cookie+="; masha-warning=true"}}},_show_message:function(){var z=this;if(this.get_message_closed()){return}this.show_message();clearTimeout(this.msg_autoclose);this.msg_autoclose=setTimeout(function(){z.hide_message()},10000)},show_message:function(){g(this.msg,"show")},hide_message:function(){k(this.msg,"show")}};var t=window.Range||document.createRange().constructor;t.prototype.splitBoundaries=function(){var D=this.startContainer,C=this.startOffset,A=this.endContainer,z=this.endOffset;var B=(D===A);if(A.nodeType==3&&z<A.length){A.splitText(z)}if(D.nodeType==3&&C>0){D=D.splitText(C);if(B){z-=C;A=D}C=0}this.setStart(D,C);this.setEnd(A,z)};t.prototype.getTextNodes=function(){var z=this.getElementIterator();var B=[],A;while((A=z())){if(A.nodeType==3){B.push(A)}}return B};function b(D,A,B,E){E=!!E;A=A||D[E?"lastChild":"firstChild"];var F=!A;var z=false;function C(){if(F){return null}var G=A;if(A.childNodes&&A.childNodes.length&&!z){A=A[E?"lastChild":"firstChild"]}else{if(A[E?"previousSibling":"nextSibling"]){A=A[E?"previousSibling":"nextSibling"];z=false}else{if(A.parentNode){A=A.parentNode;if(A===D){F=true}z=true;C()}}}if(G===B){F=true}return G}return C}t.prototype.getElementIterator=function(z){if(z){return b(null,this.endContainer,this.startContainer,true)}else{return b(null,this.startContainer,this.endContainer)}};t.prototype.getWordIterator=function(G,B){var I=this.getElementIterator(B);var z;var H=0,C=0;var A=false,F,E=this;function D(){if(H==C&&!A){do{do{z=I()}while(z&&z.nodeType!=3);A=!z;if(!A){value=z.nodeValue;if(z==E.endContainer){value=value.substr(0,E.endOffset)}if(z==E.startContainer){value=value.substr(E.startOffset)}F=value.match(G)}}while(z&&!F);if(F){H=B?0:F.length-1;C=B?F.length-1:0}}else{if(B){C--}else{C++}}if(A){return null}return F[C]}return D};t.prototype.wrapSelection=function(B){this.splitBoundaries();var C=this.getTextNodes();for(var z=C.length;z--;){var A=document.createElement("span");A.className=B;C[z].parentNode.insertBefore(A,C[z]);A.appendChild(C[z])}};e.LocationHandler=l;window.MaSha=e;if(window.jQuery){window.jQuery.fn.masha=function(z){z=z||{};z=w({selectable:this[0]},z);return new e(z)}}function w(A){for(var z=1;z<arguments.length;z++){for(key in arguments[z]){A[key]=arguments[z][key]}}return A}function r(z){return(z||"").replace(/^\s+|\s+$/g,"")}function y(A,z){var B="";if(document.defaultView&&document.defaultView.getComputedStyle){B=document.defaultView.getComputedStyle(A,"").getPropertyValue(z)}else{if(A.currentStyle){z=z.replace(/\-(\w)/g,function(C,D){return D.toUpperCase()});B=A.currentStyle[z]}}return B}function x(z){return z.textContent||z.innerText}function q(A,z){while(A&&!a(A,z)){A=A.parentNode}return A||null}function o(C,A){var z=b(C);var B=null;while((B=z())){if(B.nodeType===1&&a(B,A)){return B}}return null}function n(B,z){var A=c(B,z);if(A){return A[A.length-1]}return null}function h(B){var z=b(B);var A=null;while((A=z())){if(A.nodeType===3){return A}}return A}function c(D,A){if(D.getElementsByClassName){return D.getElementsByClassName(A)}else{var B=[],C;var z=b(D);while((C=z())){if(C.nodeType==1&&a(C,A)){B.push(C)}}return B}}function d(C){var A=[],B;var z=b(C);while((B=z())){if(B.nodeType===3){A.push(B)}}return A}function j(z){return new RegExp("(^|\\s+)"+z+"(?:$|\\s+)","g")}function a(B,z){var A=j(z);return A.test(B.className)}function g(B,z){var A=j(z);if(!A.test(B.className)){B.className=B.className+" "+z}}function k(B,z){var A=j(z);if(A.test(B.className)){B.className=r(B.className.replace(A,"$1"))}}function v(B,C){for(var z=0,A=C.length;z<A;z++){if(C[z]===B){return z}}return -1}function p(B,A,z){if(B.addEventListener){B.addEventListener(A,z,false)}else{if(B.attachEvent){B.attachEvent("on"+A,z)}}}function f(z){if(z.preventDefault){z.preventDefault()}else{z.returnValue=false}}function u(z){if(z.stopPropagation){z.stopPropagation()}else{z.cancelBubble=true}}function s(C){if(C.pageX==null){var B=document.documentElement,A=document.body;var z=C.clientX+(B&&B.scrollLeft||A&&A.scrollLeft||0)-(B.clientLeft||0);var D=C.clientY+(B&&B.scrollTop||A&&A.scrollTop||0)-(B.clientTop||0);return{x:z,y:D}}return{x:C.pageX,y:C.pageY}}})();